---
- name: Скачиваю GPG-ключ репозиториев Docker
  ansible.builtin.get_url:
    url:   https://download.docker.com/linux/ubuntu/gpg
    dest:  /etc/apt/keyrings/docker-apt-keyring.asc
    mode:  "0644"
  tags: add-gpg

- name: Добавление GPG-ключа Docker
  apt_key:
    file:  /etc/apt/keyrings/docker-apt-keyring.asc
    state: present
  tags: add-gpg

- name: Добавление Docker-репозитория
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }} signed-by=/etc/apt/keyrings/docker-apt-keyring.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present

- name: Обновление кеша apt
  ansible.builtin.apt:
    update_cache: true

- name: Установка Docker
  ansible.builtin.apt:
    name:  "{{ docker_packages }}"
    state: present

- name: Убедиться, что Docker работает
  ansible.builtin.service:
    name:    docker
    enabled: true
    state:   started

- name: Добавление текущего пользователя в группу docker
  ansible.builtin.user:
    name:   "{{ ansible_user_id }}"
    groups: docker
    append: yes
  when: ansible_user_id != 'root'

- name: Проверка версии Docker
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false

- name: Вывод версии Docker
  ansible.builtin.debug:
    msg: "{{ docker_version.stdout }}"
